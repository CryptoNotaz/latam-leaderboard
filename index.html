<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LATAM Coins Leaderboard — Dexscreener</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Evita que el texto salte al abrir/cerrar detalles */
    .transition-height { transition: height .2s ease; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto px-3 sm:px-6 py-6">
    <header class="mb-6 text-center">
      <h1 class="text-2xl sm:text-3xl font-bold">LATAM Coins Leaderboard</h1>
    </header>

    <section class="grid gap-4 items-start">
      <div>
        <div class="flex items-center gap-3 mb-3 justify-center sm:justify-start">
          <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-black text-white font-medium shadow hover:opacity-90 active:opacity-80">Actualizar</button>
          <span id="status" class="text-sm text-gray-600"></span>
        </div>

        <div class="overflow-x-auto bg-white rounded-2xl shadow">
          <table class="w-full table-auto text-xs sm:text-sm" id="table">
            <thead class="bg-gray-100 sticky top-0 z-10">
              <tr>
                <th class="w-6 px-2 py-2 sm:px-4 sm:py-3 text-left">#</th>
                <th class="px-2 py-2 sm:px-4 sm:py-3 text-left">Ticker</th>
                <th class="w-24 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right">Precio</th>
                <th class="w-14 sm:w-20 px-2 py-2 sm:px-4 sm:py-3 text-right">24h</th>
                <th class="w-24 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right">Market Cap</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-xs text-gray-500">
      <div class="flex items-center gap-2 justify-center sm:justify-start">
        <img src="./v1ps-logo.png" alt="V1PS" class="w-4 h-4 rounded">
        <span>Powered by <a class="underline" href="https://x.com/V1PS_NFTs" target="_blank" rel="noopener">V1PS</a></span>
      </div>
    </footer>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const REFRESH_MS = 60000; // auto-refresh cada 60s

    // Lista demo para VER en el canvas (si tokens.json no está disponible aquí)
    const TOKENS_FALLBACK = [
      { "chain": "solana", "address": "BS7HxRitaY5ipGfbek1nmatWLbaS9yoWRSEQzCb3pump" },
      { "chain": "solana", "address": "DsMWZg6mkheTV2XTkbUtWcsXaajTzEkk1TC7o6Fmpump" },
      { "chain": "solana", "address": "9Uxjbn2TyfEmjaYs1qXiLt3FbE3VDa5UMkvQGZwQpump" },
      { "chain": "solana", "address": "9RLoB3YZwk9sK78ZhmiSAj8CtPhssuJR1pVR326Vpump" }
    ];

    const USD_QUOTES = ['USD', 'USDC', 'USDT', 'DAI', 'USD1', 'USDE', 'USDX'];

    const fmtNum = (n, max = 2) => new Intl.NumberFormat('en-US', { maximumFractionDigits: max }).format(n);
    const fmtUsd = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(n);
    const fmtUsdSmart = (n) => {
      const opts = { style: 'currency', currency: 'USD' };
      if (Math.abs(n) >= 1) { opts.minimumFractionDigits = 2; opts.maximumFractionDigits = 2; }
      else { opts.minimumFractionDigits = 5; opts.maximumFractionDigits = 5; }
      return new Intl.NumberFormat('en-US', opts).format(n);
    };
    const fmtUsdCompact = (n) => {
      try {
        return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', notation:'compact', maximumFractionDigits: 2 }).format(n);
      } catch { // fallback manual
        const abs = Math.abs(n);
        const units = [['T',1e12],['B',1e9],['M',1e6],['K',1e3]];
        for (const [s,v] of units) if (abs >= v) return '$' + (n/v).toFixed(2) + s;
        return fmtUsd(n);
      }
    };

    // Intenta obtener la URL de X/Twitter desde Dexscreener
    function getXUrl(info) {
      const socials = info?.socials || [];
      const byType = socials.find(s => /twitter|x/i.test(s?.type || s?.platform || ''));
      if (byType?.url) return byType.url;
      const byUrl = socials.find(s => /twitter\.com|x\.com/i.test(s?.url || ''));
      return byUrl?.url || null;
    }

    // Carga lista de tokens
    async function loadTokenList() {
      try {
        const res = await fetch('./tokens.json?ts=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('No se pudo cargar tokens.json');
        const list = await res.json();
        return list.map(x => ({ chain: (x.chain || 'solana').toLowerCase(), address: x.address }));
      } catch (err) {
        console.warn('tokens.json no disponible, usando TOKENS_FALLBACK', err);
        statusEl.textContent = 'Usando lista demo (canvas); coloca tokens.json en tu repo para producción';
        return TOKENS_FALLBACK.map(x => ({ chain: x.chain.toLowerCase(), address: x.address }));
      }
    }

    function groupByChain(items) {
      const map = new Map();
      for (const it of items) {
        if (!map.has(it.chain)) map.set(it.chain, []);
        map.get(it.chain).push(it.address);
      }
      return map;
    }

    function chooseBestPairs(pairs) {
      const best = new Map();
      for (const p of pairs) {
        const base = p?.baseToken?.address; if (!base) continue;
        const qSym = (p.quoteToken?.symbol || '').toUpperCase();
        const isUsd = USD_QUOTES.some(u => qSym.includes(u));
        const liq = p.liquidity?.usd ?? 0;
        const vol = p.volume?.h24 ?? 0;
        const score = (isUsd ? 1 : 0) * 1e12 + liq * 1e6 + vol; // prefer USD, then liquidity, then volume
        const prev = best.get(base);
        if (!prev || score > prev.__score) { p.__score = score; best.set(base, p); }
      }
      return [...best.values()];
    }

    async function fetchByChain(chain, addresses) {
      const chunk = (arr, n) => arr.length ? [arr.slice(0, n), ...chunk(arr.slice(n), n)] : [];
      const chunks = chunk(addresses, 30);
      const results = [];
      for (const addrs of chunks) {
        const url = `https://api.dexscreener.com/tokens/v1/${encodeURIComponent(chain)}/${addrs.join(',')}`;
        const res = await fetch(url, { headers: { 'accept': 'application/json' } });
        if (!res.ok) throw new Error(`Dexscreener ${chain} ${res.status}`);
        const data = await res.json();
        results.push(...data);
      }
      return results;
    }

    async function fetchAll(lines) {
      const groups = groupByChain(lines);
      const arrays = await Promise.all(
        [...groups.entries()].map(([chain, addrs]) => fetchByChain(chain, addrs))
      );
      return chooseBestPairs(arrays.flat());
    }

    function render(rows) {
      tbody.innerHTML = '';
      const tokens = rows.map(p => ({
        name: p.baseToken?.name || '—',
        symbol: (p.baseToken?.symbol || '').toUpperCase(),
        address: p.baseToken?.address || '',
        imageUrl: p.info?.imageUrl || '',
        priceUsd: p.priceUsd ? Number(p.priceUsd) : null,
        mc: (typeof p.marketCap === 'number' ? p.marketCap : null),
        fdv: (typeof p.fdv === 'number' ? p.fdv : null),
        liq: p.liquidity?.usd ?? null,
        change24: p.priceChange?.h24 ?? null,
        xUrl: getXUrl(p.info),
        chainId: p.chainId,
        url: p.url
      }));

      tokens.sort((a,b) => ((b.mc ?? b.fdv ?? 0) - (a.mc ?? a.fdv ?? 0)));

      tokens.forEach((t, i) => {
        const tr = document.createElement('tr');
        tr.className = 'group cursor-pointer hover:bg-gray-50 leading-tight';
        const chg = t.change24;
        const chgClass = chg == null ? '' : (chg >= 0 ? 'text-green-600' : 'text-red-600');
        const cap = t.mc ?? t.fdv;
        const badge = t.mc != null ? 'MC' : (t.fdv != null ? 'FDV' : '—');
        tr.innerHTML = `
          <td class="w-6 px-2 py-2 sm:px-4 sm:py-3 text-gray-500">${i + 1}</td>
          <td class="px-2 py-2 sm:px-4 sm:py-3">
            <div class="flex items-center gap-1.5 sm:gap-2 min-w-0">
              ${t.imageUrl ? `<img src="${t.imageUrl}" class="w-5 h-5 rounded-full"/>` : ''}
              <span class="font-semibold truncate lp-copy" data-copy="${t.address || ''}" title="Mantén presionado para copiar CA">${t.symbol || t.name}</span>
              
              <span class="inline-flex text-[10px] px-1.5 py-0.5 rounded bg-gray-200">${t.chainId}</span>
              ${t.url ? `<a href="${t.url}" class="hidden md:inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200" title="Ver en Dexscreener">↗</a>` : ''}
              ${t.xUrl ? `<a href="${t.xUrl}" class="hidden md:inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200" title="X / Twitter">
                <svg viewBox="0 0 24 24" class="w-3.5 h-3.5" fill="currentColor" aria-hidden="true"><path d="M18.244 3.515h3.167l-6.92 7.91 8.11 9.06H19.21l-5.66-6.328-6.465 6.328H3.917l7.405-7.245-7.87-8.726h4.04l5.157 5.723 5.595-5.723Zm-1.112 16.01h1.755L7.94 5.864H6.06l11.072 13.662Z"></path></svg>
              </a>` : ''}
              ${t.address ? `<button class="copy relative shrink-0 hidden sm:inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200" data-copy="${t.address}" aria-label="Copiar CA">
                <svg viewBox="0 0 24 24" class="w-3.5 h-3.5" fill="currentColor" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                <span class="tooltip absolute top-7 right-0 bg-black text-white text-[10px] px-2 py-0.5 rounded opacity-0 pointer-events-none transition-opacity">Copiado</span>
              </button>` : ''}
            </div>
          </td>
          <td class="w-28 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">${t.priceUsd != null ? fmtUsdSmart(t.priceUsd) : '—'}</td>
          <td class="w-16 sm:w-20 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap ${chgClass}">${chg != null ? fmtNum(chg, 2) + '%' : '—'}</td>
          
          <td class="w-24 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">
            <span class="md:hidden">${cap != null ? fmtUsdCompact(cap) : '—'}</span>
            <span class="hidden md:inline">${cap != null ? fmtUsd(cap) : '—'} <span class="ml-1 text-[10px] px-1 py-0.5 rounded bg-gray-100 border">${badge}</span></span>
          </td>
        `;
        tbody.appendChild(tr);

        // Fila de detalles (acordeón)
        const det = document.createElement('tr');
        det.className = 'details hidden bg-white/70';
        det.innerHTML = `
          <td colspan="5" class="px-4 py-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 text-xs text-gray-700">
              <div class="md:col-span-4 flex items-center gap-2 text-sm"><!-- header detalles con nombre completo -->
                ${t.imageUrl ? `<img src="${t.imageUrl}" class="w-5 h-5 rounded-full"/>` : ''}
                <span class="font-semibold">${t.name || '—'}</span>
                <span class="text-xs text-gray-500 uppercase">${t.symbol}</span>
                <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-200">${t.chainId}</span>
              </div>
              <div class="md:col-span-4 flex flex-wrap items-center gap-2"><span class="font-medium">CA:</span> <code class="font-mono text-xs sm:text-[13px] break-all md:whitespace-nowrap select-all">${t.address || '—'}</code> <button class="copy relative inline-flex items-center gap-1 border rounded px-2 py-0.5 ml-1" data-copy="${t.address || ''}">Copiar<span class="tooltip absolute top-7 right-0 bg-black text-white text-[10px] px-2 py-0.5 rounded opacity-0 pointer-events-none transition-opacity">Copiado</span></button></div>
              <div><span class="font-medium">Liquidez:</span> ${t.liq != null ? fmtUsd(t.liq) : '—'}</div>
              <div><span class="font-medium">Market Cap:</span> ${cap != null ? fmtUsd(cap) : '—'} (${badge})</div>
              ${t.fdv != null ? `<div><span class="font-medium">FDV:</span> ${fmtUsd(t.fdv)}</div>` : ''}
              <div class="flex gap-2">
                ${t.url ? `<a href="${t.url}" target="_blank" rel="noopener" class="border rounded px-3 py-1">Dexscreener</a>` : ''}
                ${t.xUrl ? `<a href="${t.xUrl}" target="_blank" rel="noopener" class="border rounded px-3 py-1">X/Twitter</a>` : ''}
              </div>
            </div>
          </td>`;
        tbody.appendChild(det);
      });
    }

    async function refresh() {
      try {
        statusEl.textContent = 'Cargando…';
        const list = await loadTokenList();
        if (!list.length) { tbody.innerHTML = ''; statusEl.textContent = 'Agrega tokens a tokens.json'; return; }
        const pairs = await fetchAll(list);
        render(pairs);
        statusEl.textContent = `Actualizado: ${new Date().toLocaleTimeString()} · Auto 60s`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error al actualizar.';
      }
    }

    // --- Test cases básicos (debug) --- //
    (function runTests(){
      try {
        console.assert(fmtUsdSmart(1.2345) === '$1.23', 'fmtUsdSmart ≥1 debe tener 2 decimales');
        console.assert(fmtUsdSmart(0.0001234).includes('0.00012'), 'fmtUsdSmart <1 debe tener 5 decimales');
        console.assert(getXUrl({ socials:[{type:'twitter', url:'https://twitter.com/test'}] }) === 'https://twitter.com/test', 'getXUrl por type');
        console.assert(getXUrl({ socials:[{url:'https://x.com/test'}] }) === 'https://x.com/test', 'getXUrl por url');
        // chooseBestPairs: prioriza USD y más liquidez
        const fake = [
          { baseToken:{address:'A'}, quoteToken:{symbol:'SOL'}, liquidity:{usd:100}, volume:{h24:1} },
          { baseToken:{address:'A'}, quoteToken:{symbol:'USDC'}, liquidity:{usd:50}, volume:{h24:1} },
          { baseToken:{address:'B'}, quoteToken:{symbol:'USDT'}, liquidity:{usd:10}, volume:{h24:1} }
        ];
        const chosen = chooseBestPairs(fake);
        const a = chosen.find(x=>x.baseToken.address==='A');
        const b = chosen.find(x=>x.baseToken.address==='B');
        console.assert(a && /USDC/.test(a.quoteToken.symbol),'Debe elegir par USD para A');
        console.assert(b, 'Debe incluir B');
      } catch(e){ console.warn('Tests warning:', e); }
    })();

    refreshBtn.addEventListener('click', refresh);
    refresh();
    setInterval(refresh, REFRESH_MS);

    // Copia segura con fallback (Clipboard API -> execCommand)
    async function copyTextSafe(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true; // Clipboard API
      } catch (e) {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok; // execCommand fallback
        } catch {
          return false;
        }
      }
    }

    // Long-press copy (ticker)
    let lpTimer = null; let suppressClickUntil = 0;
    function showToastNear(el, text){
      try{
        const r = el.getBoundingClientRect();
        const tip = document.createElement('div');
        tip.textContent = text;
        tip.style.position='fixed'; tip.style.left = (r.left+window.scrollX)+'px'; tip.style.top=(r.bottom+window.scrollY+6)+'px';
        tip.className='z-50 bg-black text-white text-[10px] px-2 py-0.5 rounded shadow';
        document.body.appendChild(tip);
        setTimeout(()=>tip.remove(), 900);
      }catch(_){ /* noop */ }
    }
    function lpStart(e){
      const t = e.target.closest('.lp-copy');
      if(!t) return;
      if(lpTimer) clearTimeout(lpTimer);
      lpTimer = setTimeout(async ()=>{
        lpTimer=null;
        const text = t.getAttribute('data-copy')||'';
        if(!text) return;
        const ok = await copyTextSafe(text);
        showToastNear(t, ok? 'Copiado' : 'No permitido');
        suppressClickUntil = Date.now()+400; // evita abrir detalle tras long-press
      }, 550);
    }
    function lpEnd(){ if(lpTimer){ clearTimeout(lpTimer); lpTimer=null; } }
    tbody.addEventListener('touchstart', lpStart, {passive:true});
    tbody.addEventListener('mousedown', lpStart);
    ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>tbody.addEventListener(ev, lpEnd));

    // Delegación de eventos: COPIAR, abrir/cerrar detalles
    tbody.addEventListener('click', async (e) => {
      const copyBtn = e.target.closest('.copy');
      if (copyBtn) {
        const text = copyBtn.getAttribute('data-copy') || '';
        let ok = false;
        if (text) ok = await copyTextSafe(text);

        // Último recurso en entornos restringidos (canvas/iframe): abrir prompt para que el usuario copie manualmente
        if (!ok && window.top !== window.self && text) {
          try { window.prompt('Copiar CA (selecciona y copia):', text); ok = true; } catch(_) {}
        }

        const tip = copyBtn.querySelector('.tooltip');
        if (tip) {
          tip.textContent = ok ? 'Copiado' : 'No permitido';
          tip.classList.remove('opacity-0');
          tip.classList.add('opacity-100');
          setTimeout(()=> { tip.classList.add('opacity-0'); tip.classList.remove('opacity-100'); tip.textContent = 'Copiado'; }, 1200);
        }
        e.stopPropagation();
        return; // no toggle
      }

      // Si clic en un enlace, no togglear
      if (e.target.closest('a')) return;

      // Evitar toggle si venimos de long-press
      if (Date.now() < suppressClickUntil) return;

      // Alternar la fila de detalles (siguiente hermano)
      const row = e.target.closest('tr');
      if (!row) return;
      const details = row.nextElementSibling;
      if (details && details.classList.contains('details')) {
        details.classList.toggle('hidden');
      }
    });
  </script>
</body>
</html>

