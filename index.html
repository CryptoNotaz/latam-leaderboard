<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LATAM Coins Leaderboard — Dexscreener</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-bold">LATAM Coins Leaderboard</h1>
      
    </header>

    <section class="grid gap-4 items-start">
      <div>
        <div class="flex items-center gap-3 mb-3 justify-center sm:justify-start">
          <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-black text-white font-medium shadow hover:opacity-90 active:opacity-80">Actualizar</button>
          <span id="status" class="text-sm text-gray-600"></span>
        </div>

        <div class="overflow-x-auto bg-white rounded-2xl shadow">
          <table class="min-w-full text-sm" id="table">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-3 text-left">#</th>
                <th class="px-4 py-3 text-left">Moneda</th>
                <th class="px-4 py-3 text-right">Precio</th>
                <th class="px-4 py-3 text-right">Cap (MC/FDV)</th>
                <th class="px-4 py-3 text-right">Liquidez</th>
                <th class="px-4 py-3 text-right">24h</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-xs text-gray-500">
      <div class="flex items-center gap-2 justify-center sm:justify-start">
        <img src="./v1ps-logo.png" alt="V1PS" class="w-4 h-4 rounded">
        <span>Powered by <a class="underline" href="https://x.com/V1PS_NFTs" target="_blank" rel="noopener">V1PS</a></span>
      </div>
    </footer>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const REFRESH_MS = 60000; // auto-refresh cada 60s

    const USD_QUOTES = ['USD', 'USDC', 'USDT', 'DAI', 'USD1', 'USDE', 'USDX'];

    const fmtNum = (n, max = 2) => new Intl.NumberFormat('en-US', { maximumFractionDigits: max }).format(n);
    const fmtUsd = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(n);
    const fmtUsdSmart = (n) => {
      const opts = { style: 'currency', currency: 'USD' };
      if (Math.abs(n) >= 1) { opts.minimumFractionDigits = 2; opts.maximumFractionDigits = 2; }
      else { opts.minimumFractionDigits = 5; opts.maximumFractionDigits = 5; }
      return new Intl.NumberFormat('en-US', opts).format(n);
    };

    // Intenta obtener la URL de X/Twitter desde Dexscreener
    function getXUrl(info) {
      const socials = info?.socials || [];
      const byType = socials.find(s => /twitter|x/i.test(s?.type || s?.platform || ''));
      if (byType?.url) return byType.url;
      const byUrl = socials.find(s => /twitter\.com|x\.com/i.test(s?.url || ''));
      return byUrl?.url || null;
    }

    async function loadTokenList() {
      try {
        const res = await fetch('./tokens.json?ts=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('No se pudo cargar tokens.json');
        const list = await res.json();
        return list.map(x => ({ chain: (x.chain||'solana').toLowerCase(), address: x.address }));
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'No se pudo cargar tokens.json';
        return [];
      }
    }

    function groupByChain(items) {
      const map = new Map();
      for (const it of items) {
        if (!map.has(it.chain)) map.set(it.chain, []);
        map.get(it.chain).push(it.address);
      }
      return map;
    }

    function chooseBestPairs(pairs) {
      const best = new Map();
      for (const p of pairs) {
        const base = p?.baseToken?.address; if (!base) continue;
        const qSym = (p.quoteToken?.symbol || '').toUpperCase();
        const isUsd = USD_QUOTES.some(u => qSym.includes(u));
        const liq = p.liquidity?.usd ?? 0;
        const vol = p.volume?.h24 ?? 0;
        const score = (isUsd ? 1 : 0) * 1e12 + liq * 1e6 + vol; // prefer USD, then liquidity, then volume
        const prev = best.get(base);
        if (!prev || score > prev.__score) { p.__score = score; best.set(base, p); }
      }
      return [...best.values()];
    }

    async function fetchByChain(chain, addresses) {
      const chunk = (arr, n) => arr.length ? [arr.slice(0, n), ...chunk(arr.slice(n), n)] : [];
      const chunks = chunk(addresses, 30);
      const results = [];
      for (const addrs of chunks) {
        const url = `https://api.dexscreener.com/tokens/v1/${encodeURIComponent(chain)}/${addrs.join(',')}`;
        const res = await fetch(url, { headers: { 'accept': 'application/json' } });
        if (!res.ok) throw new Error(`Dexscreener ${chain} ${res.status}`);
        const data = await res.json();
        results.push(...data);
      }
      return results;
    }

    async function fetchAll(lines) {
      const groups = groupByChain(lines);
      const arrays = await Promise.all(
        [...groups.entries()].map(([chain, addrs]) => fetchByChain(chain, addrs))
      );
      return chooseBestPairs(arrays.flat());
    }

    function render(rows) {
      tbody.innerHTML = '';
      const tokens = rows.map(p => ({
        name: p.baseToken?.name || '—',
        symbol: (p.baseToken?.symbol || '').toUpperCase(),
        imageUrl: p.info?.imageUrl || '',
        priceUsd: p.priceUsd ? Number(p.priceUsd) : null,
        mc: (typeof p.marketCap === 'number' ? p.marketCap : null),
        fdv: (typeof p.fdv === 'number' ? p.fdv : null),
        liq: p.liquidity?.usd ?? null,
        change24: p.priceChange?.h24 ?? null,
        xUrl: getXUrl(p.info),
        chainId: p.chainId,
        url: p.url
      }));

      tokens.sort((a,b) => ((b.mc ?? b.fdv ?? 0) - (a.mc ?? a.fdv ?? 0)));

      tokens.forEach((t, i) => {
        const tr = document.createElement('tr');
        tr.className = i % 2 ? 'bg-white' : 'bg-gray-50 hover:bg-gray-100 cursor-pointer';
        const badge = t.mc != null ? 'MC' : (t.fdv != null ? 'FDV' : '—');
        const cap = t.mc ?? t.fdv;
        const chg = t.change24;
        const chgClass = chg == null ? '' : (chg >= 0 ? 'text-green-600' : 'text-red-600');
        tr.innerHTML = `
          <td class="px-4 py-3">${i + 1}</td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              ${t.imageUrl ? `<img src="${t.imageUrl}" class="w-5 h-5 rounded-full"/>` : ''}
              <div class="flex items-center gap-2">
                <span class="font-medium">${t.name}</span>
                <span class="uppercase text-xs text-gray-500">${t.symbol}</span>
                <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-200">${t.chainId}</span>
                ${t.xUrl ? `<a href="${t.xUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation()" class="inline-flex items-center justify-center w-5 h-5 rounded hover:bg-gray-200" title="X / Twitter">
                  <svg viewBox="0 0 24 24" class="w-3.5 h-3.5" fill="currentColor" aria-hidden="true">
                    <path d="M18.244 3.515h3.167l-6.92 7.91 8.11 9.06H19.21l-5.66-6.328-6.465 6.328H3.917l7.405-7.245-7.87-8.726h4.04l5.157 5.723 5.595-5.723Zm-1.112 16.01h1.755L7.94 5.864H6.06l11.072 13.662Z"></path>
                  </svg>
                </a>` : ``}
              </div>
            </div>
          </td>
          <td class="px-4 py-3 text-right">${t.priceUsd != null ? fmtUsdSmart(t.priceUsd) : '—'}</td>
          <td class="px-4 py-3 text-right">
            ${cap != null ? fmtUsd(cap) : '—'}
            <span class="ml-1 text-[10px] px-1 py-0.5 rounded bg-gray-100 border">${badge}</span>
          </td>
          <td class="px-4 py-3 text-right">${t.liq != null ? fmtUsd(t.liq) : '—'}</td>
          <td class="px-4 py-3 text-right ${chgClass}">${chg != null ? fmtNum(chg, 2) + '%' : '—'}</td>
        `;
        tr.addEventListener('click', () => { if (t.url) window.open(t.url, '_blank'); });
        tbody.appendChild(tr);
      });
    }

    async function refresh() {
      try {
        statusEl.textContent = 'Cargando…';
        const list = await loadTokenList();
        if (!list.length) { tbody.innerHTML = ''; statusEl.textContent = 'Agrega tokens a tokens.json'; return; }
        const pairs = await fetchAll(list);
        render(pairs);
        statusEl.textContent = `Actualizado: ${new Date().toLocaleTimeString()} · Auto 60s`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error al actualizar.';
      }
    }

    refreshBtn.addEventListener('click', refresh);
    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>



