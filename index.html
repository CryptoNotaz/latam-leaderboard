<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LATAM Coins Leaderboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Modo oscuro guardado en localStorage
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme');
    if ((savedTheme === 'dark') || (!savedTheme && prefersDark)) {
      document.documentElement.classList.add('dark');
    }
  </script>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900 dark:bg-neutral-950 dark:text-neutral-100">
  <div class="relative">
    <div class="absolute inset-0 -z-10 bg-gradient-to-b from-fuchsia-100/60 via-transparent to-transparent dark:from-fuchsia-500/10"></div>
  </div>

  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6 flex items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-black tracking-tight">LATAM Coins Leaderboard</h1>
        <p class="text-sm md:text-base text-gray-600 dark:text-gray-400 mt-1">Datos de <b>Dexscreener</b>. Orden por <b>Market Cap</b>; si falta, <b>FDV</b>. Click en una fila para abrir Dexscreener.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeBtn" class="px-3 py-2 rounded-xl border bg-white/70 backdrop-blur text-sm dark:bg-neutral-900 dark:border-neutral-800">üåô/‚òÄÔ∏è</button>
      </div>
    </header>

    <section class="grid gap-4 md:grid-cols-5 items-start">
      <div class="md:col-span-5">
        <div class="flex items-center gap-3 mb-3">
          <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-black text-white font-medium shadow hover:opacity-90 active:opacity-80 dark:bg-white dark:text-black">Actualizar</button>
          <span id="status" class="text-sm text-gray-600 dark:text-gray-400"></span>
        </div>

        <div class="overflow-x-auto rounded-2xl shadow ring-1 ring-black/5 dark:ring-white/10 bg-white dark:bg-neutral-900">
          <table class="min-w-full text-sm" id="table">
            <thead class="bg-gray-100/80 dark:bg-neutral-800/60">
              <tr>
                <th class="px-4 py-3 text-left">#</th>
                <th class="px-4 py-3 text-left">Moneda</th>
                <th class="px-4 py-3 text-right">Precio</th>
                <th class="px-4 py-3 text-right">Cap (MC/FDV)</th>
                <th class="px-4 py-3 text-right">Liquidez</th>
                <th class="px-4 py-3 text-right">24h</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-xs text-gray-500 dark:text-gray-400">
      <p>Lectura p√∫blica. La lista de tokens proviene de <code>tokens.json</code> en el mismo directorio. Solo quien tenga acceso de escritura al repositorio puede cambiarla.</p>
    </footer>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const themeBtn = document.getElementById('themeBtn');

    themeBtn.addEventListener('click', () => {
      const root = document.documentElement;
      if (root.classList.contains('dark')) {
        root.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      } else {
        root.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }
    });

    const USD_QUOTES = ['USD', 'USDC', 'USDT', 'DAI', 'USD1', 'USDE', 'USDX'];

    const fmtNum = (n, max = 2) => new Intl.NumberFormat('en-US', { maximumFractionDigits: max }).format(n);
    const fmtUsd = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(n);

    async function loadTokenList() {
      try {
        const res = await fetch('./tokens.json?ts=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('No se pudo cargar tokens.json');
        const list = await res.json();
        // Normaliza items: {chain, address}
        return list.map(x => ({ chain: (x.chain||'solana').toLowerCase(), address: x.address }));
      } catch (err) {
        console.warn('Fallo tokens.json, usando fallback:', err);
        // Fallback con tus 2 tokens de ejemplo
        return [
          { chain: 'solana', address: 'BS7HxRitaY5ipGfbek1nmatWLbaS9yoWRSEQzCb3pump' },
          { chain: 'solana', address: '9RLoB3YZwk9sK78ZhmiSAj8CtPhssuJR1pVR326Vpump' },
        ];
      }
    }

    function groupByChain(items) {
      const map = new Map();
      for (const it of items) {
        if (!map.has(it.chain)) map.set(it.chain, []);
        map.get(it.chain).push(it.address);
      }
      return map;
    }

    function chooseBestPairs(pairs) {
      const best = new Map();
      for (const p of pairs) {
        const base = p?.baseToken?.address; if (!base) continue;
        const qSym = (p.quoteToken?.symbol || '').toUpperCase();
        const isUsd = USD_QUOTES.some(u => qSym.includes(u));
        const liq = p.liquidity?.usd ?? 0;
        const vol = p.volume?.h24 ?? 0;
        const score = (isUsd ? 1 : 0) * 1e12 + liq * 1e6 + vol; // USD > Liquidez > Volumen
        const prev = best.get(base);
        if (!prev || score > prev.__score) { p.__score = score; best.set(base, p); }
      }
      return [...best.values()];
    }

    async function fetchByChain(chain, addresses) {
      const chunk = (arr, n) => arr.length ? [arr.slice(0, n), ...chunk(arr.slice(n), n)] : [];
      const chunks = chunk(addresses, 30);
      const results = [];
      for (const addrs of chunks) {
        const url = `https://api.dexscreener.com/tokens/v1/${encodeURIComponent(chain)}/${addrs.join(',')}`;
        const res = await fetch(url, { headers: { 'accept': 'application/json' } });
        if (!res.ok) throw new Error(`Dexscreener ${chain} ${res.status}`);
        const data = await res.json();
        results.push(...data);
      }
      return results;
    }

    async function fetchAll(lines) {
      const groups = groupByChain(lines);
      const arrays = await Promise.all(
        [...groups.entries()].map(([chain, addrs]) => fetchByChain(chain, addrs))
      );
      return chooseBestPairs(arrays.flat());
    }

    function render(rows) {
      tbody.innerHTML = '';
      const tokens = rows.map(p => ({
        name: p.baseToken?.name || '‚Äî',
        symbol: (p.baseToken?.symbol || '').toUpperCase(),
        imageUrl: p.info?.imageUrl || '',
        priceUsd: p.priceUsd ? Number(p.priceUsd) : null,
        mc: (typeof p.marketCap === 'number' ? p.marketCap : null),
        fdv: (typeof p.fdv === 'number' ? p.fdv : null),
        liq: p.liquidity?.usd ?? null,
        change24: p.priceChange?.h24 ?? null,
        chainId: p.chainId,
        url: p.url
      }));

      tokens.sort((a,b) => ((b.mc ?? b.fdv ?? 0) - (a.mc ?? a.fdv ?? 0)));

      tokens.forEach((t, i) => {
        const tr = document.createElement('tr');
        tr.className = i % 2 ? 'bg-white dark:bg-neutral-900' : 'bg-gray-50 dark:bg-neutral-800 hover:bg-gray-100 dark:hover:bg-neutral-700 cursor-pointer';
        const badge = t.mc != null ? 'MC' : (t.fdv != null ? 'FDV' : '‚Äî');
        const cap = t.mc ?? t.fdv;
        const chg = t.change24;
        const chgClass = chg == null ? '' : (chg >= 0 ? 'text-green-600' : 'text-red-600');
        tr.innerHTML = `
          <td class="px-4 py-3">${i + 1}</td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              ${t.imageUrl ? `<img src="${t.imageUrl}" class="w-5 h-5 rounded-full"/>` : ''}
              <div class="flex items-center gap-2">
                <span class="font-medium">${t.name}</span>
                <span class="uppercase text-xs text-gray-500 dark:text-gray-400">${t.symbol}</span>
                <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-200 dark:bg-neutral-700">${t.chainId}</span>
              </div>
            </div>
          </td>
          <td class="px-4 py-3 text-right">${t.priceUsd != null ? fmtUsd(t.priceUsd) : '‚Äî'}</td>
          <td class="px-4 py-3 text-right">
            ${cap != null ? fmtUsd(cap) : '‚Äî'}
            <span class="ml-1 text-[10px] px-1 py-0.5 rounded bg-gray-100 dark:bg-neutral-700 border dark:border-neutral-600">${badge}</span>
          </td>
          <td class="px-4 py-3 text-right">${t.liq != null ? fmtUsd(t.liq) : '‚Äî'}</td>
          <td class="px-4 py-3 text-right ${chgClass}">${chg != null ? fmtNum(chg, 2) + '%' : '‚Äî'}</td>
        `;
        tr.addEventListener('click', () => { if (t.url) window.open(t.url, '_blank'); });
        tbody.appendChild(tr);
      });
    }

    async function refresh() {
      try {
        statusEl.textContent = 'Cargando‚Ä¶';
        const list = await loadTokenList();
        const pairs = await fetchAll(list);
        render(pairs);
        statusEl.textContent = `Actualizado: ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error al actualizar.';
      }
    }

    refreshBtn.addEventListener('click', refresh);
    refresh();
  </script>
</body>
</html>
