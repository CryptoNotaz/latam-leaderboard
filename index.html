<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Latam Market Cap â€” Dexscreener</title>

  <script>
    (function () {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const useDark = saved ? saved === 'dark' : prefersDark;
      if (useDark) document.documentElement.classList.add('dark');
    })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' };</script>

  <style>
    .transition-height { transition: height .2s ease; }
  </style>
</head>

<body class="min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <div class="max-w-screen-2xl 2xl:max-w-[1600px] mx-auto px-3 sm:px-6 lg:px-8 py-6">
    <header class="mb-6 text-center">
      <h1 class="text-2xl sm:text-3xl font-bold">Latam Market Cap</h1>
    </header>

    <div class="grid grid-cols-1 sm:grid-cols-[168px_1fr] lg:grid-cols-[192px_1fr] gap-4">
      <aside class="sm:sticky sm:top-4 sm:self-start bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-3">
        <nav class="flex sm:flex-col gap-2">
          <button id="tabCoins" class="px-3 py-2 rounded-lg bg-black text-white text-left">Coins</button>
          <button id="tabNfts" class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 dark:text-gray-100 text-left">NFTs</button>
          <button id="tabCreators" class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 dark:text-gray-100 text-left">Creadores</button>
          <button id="tabTools" class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 dark:text-gray-100 text-left">Herramientas</button>
        </nav>

        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
          <button id="themeToggle"
            class="w-full px-3 py-2 text-sm rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200
                   dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600">
            ðŸŒ™
          </button>
        </div>
      </aside>

      <main>
        <!-- Top chips -->
        <div class="mb-4 flex items-center justify-between gap-2">
          <div class="hidden sm:inline-flex items-stretch rounded-lg overflow-hidden border border-gray-300 dark:border-gray-700">
            <div id="totalMc"
                class="hidden px-3 py-1.5 text-sm bg-white text-gray-800
                      dark:bg-gray-800 dark:text-gray-100
                      flex items-center gap-2"
                title="Suma de Market Cap de los tokens listados (solo MC)">
              <span class="font-semibold">MC</span>
              <span id="totalMcValue" class="tabular-nums">$0</span>
            </div>

            <div id="totalVol"
                class="hidden px-3 py-1.5 text-sm bg-white text-gray-800 border-l border-gray-300
                      dark:bg-gray-800 dark:text-gray-100 dark:border-gray-700
                      flex items-center gap-2"
                title="Volumen 24h agregado de los tokens listados">
              <span class="font-semibold">VOL 24h</span>
              <span id="totalVolValue" class="tabular-nums">$0</span>
            </div>

            <div id="fgChip"
                class="hidden px-3 py-1.5 text-sm bg-white text-gray-800 border-l border-gray-300 select-none
                      dark:bg-gray-800 dark:text-gray-100 dark:border-gray-700
                      flex items-center gap-2"
                title="Ãndice Latam SZN">
              <svg id="fgGauge" viewBox="0 0 80 44" width="56" height="28" class="shrink-0">
                <defs>
                  <linearGradient id="fgGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%"  stop-color="#ef4444"/>
                    <stop offset="50%" stop-color="#f59e0b"/>
                    <stop offset="100%" stop-color="#22c55e"/>
                  </linearGradient>
                </defs>
                <path d="M6 40 A34 34 0 0 1 74 40"
                      stroke="url(#fgGrad)" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.9"/>
                <circle id="fgMarker" cx="6" cy="40" r="6" fill="#ffffff" stroke="currentColor" stroke-width="2"/>
              </svg>
              <div class="flex flex-col leading-none">
                <span class="text-[11px] uppercase tracking-wide text-gray-500 dark:text-gray-400">Latam SZN</span>
                <span id="fgValue" class="font-semibold tabular-nums">--</span>
                <span id="fgWord" class="text-[11px] font-medium">â€”</span>
              </div>
            </div>

            <a href="https://forms.gle/ceKKLWemXwLpcXUK8" target="_blank" rel="noopener"
              class="px-3 py-1.5 text-sm bg-white text-indigo-600 font-medium border-l border-gray-300 hover:bg-gray-100
                    dark:bg-gray-800 dark:text-indigo-400 dark:border-gray-700 dark:hover:bg-gray-700">
              Solicitar listado
            </a>
          </div>
        </div>

        <!-- COINS -->
        <section id="coins-section" class="grid gap-4 items-start">
          <div>
            <div class="flex items-center gap-3 mb-3 justify-center sm:justify-start">
              <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-black text-white font-medium shadow hover:opacity-90 active:opacity-80">Actualizar</button>
              <span id="status" class="text-sm text-gray-600 dark:text-gray-400"></span>
            </div>

            <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl lg:rounded-2xl shadow">
              <table class="w-full table-auto text-xs sm:text-sm" id="table">
                <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0 z-10">
                  <tr>
                    <th class="w-6 px-2 py-2 sm:px-4 sm:py-3 text-left">#</th>
                    <th class="px-2 py-2 sm:px-4 sm:py-3 text-left">Ticker</th>
                    <th class="w-24 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right">Precio</th>
                    <th class="w-16 sm:w-20 px-2 py-2 sm:px-4 sm:py-3 text-right">24h</th>
                    <th class="w-24 sm:w-28 px-2 py-2 sm:px-4 sm:py-3 text-right">Vol 24h</th>
                    <th class="w-24 sm:w-28 px-2 py-2 sm:px-4 sm:py-3 text-right">Liquidez</th>
                    <th class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right">Buy/Sell</th>
                    <th class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right">Vol/MC</th>
                    <th class="w-24 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right">Market Cap</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- NFTS -->
        <section id="nfts-section" class="grid gap-4 items-start hidden">
          <div>
            <div class="flex items-center gap-3 mb-3 justify-center sm:justify-start">
              <button id="nftRefreshBtn" class="px-4 py-2 rounded-xl bg-black text-white font-medium shadow hover:opacity-90 active:opacity-80">Actualizar</button>
              <span id="nftStatus" class="text-sm text-gray-600 dark:text-gray-400"></span>
            </div>
            <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl lg:rounded-2xl shadow">
              <table class="w-full table-auto text-xs sm:text-sm">
                <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0 z-10">
                  <tr>
                    <th class="w-6 px-2 py-2 sm:px-4 sm:py-3 text-left">#</th>
                    <th class="px-2 py-2 sm:px-4 sm:py-3 text-left">ColecciÃ³n</th>
                    <th class="w-24 sm:w-28 px-2 py-2 sm:px-4 sm:py-3 text-right">Floor</th>
                    <th class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right">24h Vol</th>
                    <th class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right">Supply</th>
                    <th class="w-24 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right">MC (floor)</th>
                  </tr>
                </thead>
                <tbody id="nftTbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CREADORES -->
        <section id="creators-section" class="grid gap-4 items-start hidden">
          <div>
            <div class="flex items-center gap-3 mb-3 justify-center sm:justify-start">
              <button id="creRefreshBtn" class="px-4 py-2 rounded-xl bg-black text-white font-medium shadow hover:opacity-90 active:opacity-80">Actualizar</button>
              <span id="creStatus" class="text-sm text-gray-600 dark:text-gray-400"></span>
            </div>
            <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl lg:rounded-2xl shadow">
              <table class="w-full table-auto text-xs sm:text-sm">
                <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0 z-10">
                  <tr>
                    <th class="w-6 px-2 py-2 sm:px-4 sm:py-3 text-left">#</th>
                    <th class="px-2 py-2 sm:px-4 sm:py-3 text-left">Creador</th>
                    <th class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right">Seguidores</th>
                    <th class="w-24 sm:w-28 px-2 py-2 sm:px-4 sm:py-3 text-right">Roles</th>
                  </tr>
                </thead>
                <tbody id="creTbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- HERRAMIENTAS -->
        <section id="tools-section" class="grid gap-4 items-start hidden">
          <div>
            <div class="flex items-center gap-3 mb-3 justify-center sm:justify-start">
              <button id="toolsRefreshBtn" class="px-4 py-2 rounded-xl bg-black text-white font-medium shadow hover:opacity-90 active:opacity-80">Actualizar</button>
              <span id="toolsStatus" class="text-sm text-gray-600 dark:text-gray-400"></span>
            </div>

            <div id="toolsList" class="grid gap-3 sm:grid-cols-2">
              <!-- AquÃ­ se renderiza el comparador como card + las demÃ¡s herramientas -->
            </div>
          </div>
        </section>

        <footer class="mt-10 text-xs text-gray-500 dark:text-gray-400">
          <div class="flex items-center gap-2 justify-center sm:justify-start">
            <img src="./v1ps-logo.png" alt="V1PS" class="w-4 h-4 rounded">
            <span>Powered by <a class="underline" href="https://x.com/V1PS_NFTs" target="_blank" rel="noopener">V1PS</a></span>
          </div>
        </footer>
      </main>
    </div>
  </div>

  <!-- ========= MODAL COMPARADOR MC ========= -->
  <div id="mcModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative mx-auto mt-12 w-[95%] max-w-3xl rounded-2xl bg-white dark:bg-gray-800 p-6 shadow-2xl">
      <div class="text-center mb-5">
        <h3 class="text-2xl font-extrabold leading-tight">
          Calcula el precio de <span class="underline decoration-emerald-400">A</span>
          <span class="block sm:inline font-semibold text-emerald-500">con el market cap de B</span>
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Usa MC y, si falta, FDV.</p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-[1fr_auto_1fr] items-center gap-3">
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Select A</label>
          <div class="mt-1">
            <select id="mcSelectA" class="w-full rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 px-3 py-2"></select>
          </div>
        </div>

        <button id="mcSwap" title="Intercambiar A y B"
          class="mt-6 sm:mt-7 mx-auto w-11 h-11 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor" aria-hidden="true">
            <path d="M7 7h11l-2.5-2.5L17 3l4 4-4 4-1.5-1.5L18 7H7V5zm10 10H6l2.5 2.5L7 21l-4-4 4-4 1.5 1.5L6 17h11v2z"/>
          </svg>
        </button>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Select B</label>
          <div class="mt-1">
            <select id="mcSelectB" class="w-full rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 px-3 py-2"></select>
          </div>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-2 justify-center">
        <button id="mcCalc" class="px-5 py-2.5 rounded-xl bg-black text-white font-semibold shadow hover:opacity-90">
          Calcular
        </button>
        <span id="mcMsg" class="text-sm text-gray-600 dark:text-gray-400"></span>
      </div>

      <div id="mcOut" class="mt-5"></div>

      <div class="mt-5 text-center">
        <button id="mcClose" class="px-3 py-1.5 text-sm rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-100">
          Cerrar
        </button>
      </div>
    </div>
  </div>
  <!-- ========= /MODAL ========= -->

  <script>
    // ---------- utilidades comunes ----------
    const USD_QUOTES = ['USD','USDC','USDT','DAI','USD1','USDE','USDX'];
    const fmtNum = (n,max=2)=>new Intl.NumberFormat('en-US',{maximumFractionDigits:max}).format(n);
    const fmtUsd = (n)=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}).format(n);
    const fmtUsdSmart=(n)=>{const o={style:'currency',currency:'USD'};if(Math.abs(n)>=1){o.minimumFractionDigits=2;o.maximumFractionDigits=2;}else{o.minimumFractionDigits=5;o.maximumFractionDigits=5;}return new Intl.NumberFormat('en-US',o).format(n);};
    const fmtUsdCompact=(n)=>{try{return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',notation:'compact',maximumFractionDigits:2}).format(n);}catch{const abs=Math.abs(n),u=[['T',1e12],['B',1e9],['M',1e6],['K',1e3]];for(const[s,v]of u)if(abs>=v)return '$'+(n/v).toFixed(2)+s;return fmtUsd(n);}};
    const toNum=(v)=>{if(v===null||v===undefined)return null;const n=Number(String(v).replace(/[^0-9.]/g,''));return Number.isFinite(n)?n:null;};
    const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
    const clampAbs=(x,max)=>Math.min(Math.abs(x||0),max);

    // === NUEVO: carga de socials.json ===
    async function loadSocials(){
      try{
        const r = await fetch('./socials.json?ts='+Date.now(), {cache:'no-store'});
        if(!r.ok) throw new Error('No socials.json');
        const arr = await r.json();
        const map = new Map();
        (Array.isArray(arr)?arr:[]).forEach(it=>{
          const chain=(it.chain||'solana').toLowerCase();
          const addr=String(it.address||'').toLowerCase();
          if(!addr) return;
          map.set(addr, {
            instagram: it.instagram || it.ig || null,
            tiktok: it.tiktok || it.tt || null,
            chain
          });
        });
        return map;
      }catch(e){
        console.warn('Sin socials.json (opcional)', e);
        return new Map();
      }
    }

    const totalMcBox=document.getElementById('totalMc');
    const totalMcValue=document.getElementById('totalMcValue');
    function updateTotalMc(tokensRaw){
      if(!totalMcBox||!totalMcValue) return;
      const sum=tokensRaw.reduce((acc,p)=>{const mc=(typeof p.marketCap==='number')?p.marketCap:null;return acc+(mc||0);},0);
      if(sum>0){ totalMcValue.textContent=fmtUsdCompact(sum); totalMcBox.title=`Total MC: ${fmtUsd(sum)}`; totalMcBox.classList.remove('hidden'); }
      else{ totalMcBox.classList.add('hidden'); }
    }

    const totalVolBox=document.getElementById('totalVol');
    const totalVolValue=document.getElementById('totalVolValue');
    function updateTotalVol(pairs){
      if(!totalVolBox||!totalVolValue) return;
      const sum=pairs.reduce((acc,p)=>{
        const v=(p && p.volume && typeof p.volume.h24==='number') ? p.volume.h24 : 0;
        return acc+v;
      },0);
      if(sum>0){
        totalVolValue.textContent=fmtUsdCompact(sum);
        totalVolBox.title=`Volumen 24h: ${fmtUsd(sum)}`;
        totalVolBox.classList.remove('hidden');
      }else{
        totalVolBox.classList.add('hidden');
      }
    }

    const fgChip=document.getElementById('fgChip');
    const fgValueEl=document.getElementById('fgValue');
    const fgWordEl=document.getElementById('fgWord');
    const fgMarker=document.getElementById('fgMarker');
    const FG_EMA_KEY='latam_fgi_ema';
    const FG_TS_KEY='latam_fgi_ts';
    const FG_CACHE_MS=24*60*60*1000;
    const FG_ALPHA=0.30;

    const mapClip=(v,a,b,A,B)=>{if(a===b)return(A+B)/2;const t=clamp((v-a)/(b-a),0,1);return A+(B-A)*t;};
    const mean=arr=>arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;
    const stdev=arr=>{if(arr.length<2)return 0;const m=mean(arr);const v=mean(arr.map(x=>(x-m)**2));return Math.sqrt(v);};
    const percentile=(arr,p)=>{if(!arr.length)return 0;const a=[...arr].sort((x,y)=>x-y);const idx=clamp((p/100)*(a.length-1),0,a.length-1);const lo=Math.floor(idx),hi=Math.ceil(idx);if(lo===hi)return a[lo];const t=idx-lo;return a[lo]*(1-t)+a[hi]*t;};

    function bucketForScore(s){
      if(s<=24) return {label:'Extreme Fear', es:'PÃ¡nico', cls:'text-red-500'};
      if(s<=44) return {label:'Fear',          es:'Miedo',  cls:'text-orange-500'};
      if(s< 56) return {label:'Neutral',       es:'Neutral',cls:'text-yellow-500 dark:text-yellow-400'};
      if(s<=74) return {label:'Greed',         es:'Avaricia',cls:'text-green-500'};
      return        {label:'Extreme Greed',    es:'Bullish', cls:'text-emerald-500'};
    }

    function renderFg(shown, extras){
      const bucket=bucketForScore(shown);
      fgValueEl.textContent=shown;
      fgValueEl.className='font-semibold tabular-nums '+bucket.cls;
      if(fgWordEl){
        fgWordEl.textContent=bucket.es;
        fgWordEl.className='text-[11px] font-medium '+bucket.cls;
      }
      const r=34, cx=40, cy=40;
      const rad=Math.PI*(1 - shown/100);
      fgMarker.setAttribute('cx', String(cx + r*Math.cos(rad)));
      fgMarker.setAttribute('cy', String(cy + r*Math.sin(rad)));
      fgChip.title = extras
        ? [
            `Latam SZN: ${shown} (${bucket.es})`,
            `Breadth: ${extras.breadth}`,
            `Momentum: ${extras.momentum}`,
            `Liquidez: ${extras.liq}`,
            `Volatilidad: ${extras.vol}`
          ].join(' Â· ')
        : `Latam SZN: ${shown} (${bucket.es})`;
      fgChip.classList.remove('hidden');
    }

    function updateFearIndex(pairs){
      try{
        const now = Date.now();
        const lastTs = Number(localStorage.getItem(FG_TS_KEY)) || 0;
        const cached = Number(localStorage.getItem(FG_EMA_KEY));
        if (now - lastTs < FG_CACHE_MS && Number.isFinite(cached)) {
          renderFg(Math.round(cached)); return;
        }
        const items=pairs.map(p=>{
          const ret=toNum(p?.priceChange?.h24);
          const mc =(typeof p?.marketCap==='number')?p.marketCap:((typeof p?.fdv==='number')?p.fdv:0);
          const liq=toNum(p?.liquidity?.usd)??0;
          return {ret,mc,liq};
        }).filter(x=>Number.isFinite(x.ret)&&x.mc>0);

        if(items.length<3){ fgChip.classList.add('hidden'); return; }

        const winners=items.filter(x=>x.ret>0).length;
        const breadthScore=(winners/items.length)*100;

        const sumMc=items.reduce((a,b)=>a+b.mc,0);
        const wRetDec=items.reduce((a,b)=>a+(b.ret/100)*b.mc,0)/(sumMc||1);
        const momentumScore=mapClip(wRetDec,-0.15,+0.15,0,100);

        const ratios=items.map(x=>x.liq/x.mc).filter(Number.isFinite);
        const p10=percentile(ratios,10), p90=percentile(ratios,90);
        const liqScore=mapClip(mean(ratios),p10,p90,0,100);

        const retsDec=items.map(x=>x.ret/100);
        const volStd=stdev(retsDec);
        const volScore=100-mapClip(volStd,0,0.25,0,100);

        let score=0.35*breadthScore+0.35*momentumScore+0.20*liqScore+0.10*volScore;
        score=clamp(score,0,100);

        const prev=Number(localStorage.getItem(FG_EMA_KEY));
        const ema=Number.isFinite(prev)?(prev+FG_ALPHA*(score-prev)):score;

        localStorage.setItem(FG_EMA_KEY,String(ema));
        localStorage.setItem(FG_TS_KEY,String(now));

        const shown=Math.round(ema);
        renderFg(shown, {
          breadth: breadthScore.toFixed(1),
          momentum: momentumScore.toFixed(1),
          liq: liqScore.toFixed(1),
          vol: volScore.toFixed(1)
        });
      }catch(e){
        console.warn('FG index error', e);
        fgChip.classList.add('hidden');
      }
    }

    const PLATFORM_ICONS={
      pump:{primary:'https://unavatar.io/pump.fun',fallback:'https://pump.fun/favicon.ico'},
      bonk:{primary:'https://unavatar.io/bonk.fun',fallback:'https://bonk.fun/favicon.ico'}
    };
    function detectPlatform(address){
      if(!address) return null;
      const ca=String(address).trim(); const low=ca.toLowerCase();
      if(low.endsWith('pump')) return {key:'pump',name:'Pump.fun',url:`https://pump.fun/coin/${ca}`,iconPrimary:PLATFORM_ICONS.pump.primary,iconFallback:PLATFORM_ICONS.pump.fallback};
      if(low.endsWith('bonk')) return {key:'bonk',name:'Bonk.fun',url:`https://bonk.fun/token/${ca}`,iconPrimary:PLATFORM_ICONS.bonk.primary,iconFallback:PLATFORM_ICONS.bonk.fallback};
      return null;
    }

    const tbody=document.getElementById('tbody');
    const refreshBtn=document.getElementById('refreshBtn');
    const statusEl=document.getElementById('status');

    const lamportsToSOL=(x)=>(typeof x==='number'?x/1e9:null);
    const fmtSol=(n)=>n==null?'â€”':`â—Ž${(Math.abs(n)>=1?n.toFixed(2):n.toFixed(3))}`;
    const fmtSolCompact=(n)=>n==null?'â€”':`â—Ž${(Math.abs(n)>=1000?(n/1000).toFixed(1)+'K':(Math.abs(n)>=1?n.toFixed(2):n.toFixed(3)))}`;

    function getXUrl(info){
      const socials=info?.socials||[];
      const byType=socials.find(s=>/twitter|x/i.test(s?.type||s?.platform||'')); if(byType?.url) return byType.url;
      const byUrl=socials.find(s=>/twitter\.com|x\.com/i.test(s?.url||'')); return byUrl?.url||null;
    }

    async function loadTokenList(){
      try{
        const res=await fetch('./tokens.json?ts='+Date.now(),{cache:'no-store'});
        if(!res.ok) throw new Error('No se pudo cargar tokens.json');
        const list=await res.json();
        return list.map(x=>({chain:(x.chain||'solana').toLowerCase(),address:x.address}));
      }catch(err){
        console.warn('tokens.json no disponible, usando TOKENS_FALLBACK',err);
        statusEl.textContent='Usando lista demo; sube tokens.json para producciÃ³n';
        return TOKENS_FALLBACK.map(x=>({chain:x.chain.toLowerCase(),address:x.address}));
      }
    }

    function groupByChain(items){ const map=new Map(); for(const it of items){ if(!map.has(it.chain)) map.set(it.chain,[]); map.get(it.chain).push(it.address);} return map; }

    function chooseBestPairs(pairs){
      const best=new Map();
      for(const p of pairs){
        const base=p?.baseToken?.address; if(!base) continue;
        const qSym=(p.quoteToken?.symbol||'').toUpperCase();
        const isUsd=USD_QUOTES.some(u=>qSym.includes(u));
        const liq=p.liquidity?.usd??0;
        const the_vol=p.volume?.h24??0;
        const score=(isUsd?1:0)*1e12 + liq*1e6 + the_vol;
        const prev=best.get(base);
        if(!prev||score>prev.__score){ p.__score=score; best.set(base,p); }
      }
      return [...best.values()];
    }

    async function fetchByChain(chain,addresses){
      const chunk=(arr,n)=>arr.length?[arr.slice(0,n),...chunk(arr.slice(n),n)]:[];
      const chunks=chunk(addresses,30); const results=[];
      for(const addrs of chunks){
        const url=`https://api.dexscreener.com/tokens/v1/${encodeURIComponent(chain)}/${addrs.join(',')}`;
        const res=await fetch(url,{headers:{'accept':'application/json'}});
        if(!res.ok) throw new Error(`Dexscreener ${chain} ${res.status}`);
        const data=await res.json(); results.push(...data);
      }
      return results;
    }

    async function fetchAll(lines){
      const groups=groupByChain(lines);
      const arrays=await Promise.all([...groups.entries()].map(([chain,addrs])=>fetchByChain(chain,addrs)));
      return chooseBestPairs(arrays.flat());
    }

    // === NUEVO: Ã­conos de redes ===
    const ICONS = {
      dex: 'https://dexscreener.com/favicon.png',
      x: 'https://x.com/favicon.ico',
      ig: 'https://www.instagram.com/favicon.ico',
      tt: 'https://www.tiktok.com/favicon.ico'
    };

    function render(rows, socialsMap){
      tbody.innerHTML='';
      const tokens=rows.map(p=>{
        const addr=(p.baseToken?.address||'').toLowerCase();
        const social = socialsMap.get(addr) || {};
        return {
          name:p.baseToken?.name||'â€”',
          symbol:(p.baseToken?.symbol||'').toUpperCase(),
          address:p.baseToken?.address||'',
          imageUrl:p.info?.imageUrl||'',
          priceUsd:p.priceUsd?Number(p.priceUsd):null,
          mc:(typeof p.marketCap==='number'?p.marketCap:null),
          fdv:(typeof p.fdv==='number'?p.fdv:null),
          liq:p.liquidity?.usd??null,
          change24:p.priceChange?.h24??null,
          volume24:(p.volume?.h24 ?? null),
          buys24:(p.txns?.h24?.buys ?? null),
          sells24:(p.txns?.h24?.sells ?? null),
          xUrl:getXUrl(p.info),
          chainId:p.chainId,
          url:p.url,
          platform:detectPlatform(p.baseToken?.address),
          igUrl: social.instagram || null,
          ttUrl: social.tiktok || null
        };
      });

      // Exponer para la herramienta
      window.__LATAM_TOKENS = tokens;

      tokens.sort((a,b)=>((b.mc??b.fdv??0)-(a.mc??a.fdv??0)));

      tokens.forEach((t,i)=>{
        const tr=document.createElement('tr');
        tr.className='group cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/40 leading-tight';
        const chg=t.change24; const chgClass=chg==null?'':(chg>=0?'text-green-600':'text-red-500');
        const cap=t.mc??t.fdv; const badge=t.mc!=null?'MC':(t.fdv!=null?'FDV':'â€”');

        const dexLogo = `<img src="${ICONS.dex}" alt="Dexscreener" class="w-3.5 h-3.5 rounded-sm" referrerpolicy="no-referrer">`;
        const xLogo   = `<img src="${ICONS.x}"   alt="X"           class="w-3.5 h-3.5 rounded-sm" referrerpolicy="no-referrer">`;
        const igLogo  = `<img src="${ICONS.ig}"  alt="Instagram"  class="w-3.5 h-3.5 rounded-sm" referrerpolicy="no-referrer">`;
        const ttLogo  = `<img src="${ICONS.tt}"  alt="TikTok"      class="w-3.5 h-3.5 rounded-sm" referrerpolicy="no-referrer">`;

        tr.innerHTML=`
          <td class="w-6 px-2 py-2 sm:px-4 sm:py-3 text-gray-500 dark:text-gray-400">${i+1}</td>
          <td class="px-2 py-2 sm:px-4 sm:py-3">
            <div class="flex items-center gap-1.5 sm:gap-2 min-w-0">
              ${t.imageUrl?`<img src="${t.imageUrl}" class="w-5 h-5 rounded-full" alt="">`:''}
              <span class="font-semibold truncate lp-copy" data-copy="${t.address||''}" title="MantÃ©n presionado para copiar CA">${t.symbol||t.name}</span>
              <span class="inline-flex text-[10px] px-1.5 py-0.5 rounded bg-gray-200 dark:bg-gray-700">${t.chainId}</span>

              ${t.url?`<a href="${t.url}" target="_blank" rel="noopener" class="hidden md:inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Ver en Dexscreener">${dexLogo}</a>`:''}
              ${t.xUrl?`<a href="${t.xUrl}" target="_blank" rel="noopener" class="hidden md:inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="X / Twitter">${xLogo}</a>`:''}
              ${t.igUrl?`<a href="${t.igUrl}" target="_blank" rel="noopener" class="hidden md:inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Instagram">${igLogo}</a>`:''}
              ${t.ttUrl?`<a href="${t.ttUrl}" target="_blank" rel="noopener" class="hidden md:inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="TikTok">${ttLogo}</a>`:''}
              ${t.platform?`
                <a href="${t.platform.url}" target="_blank" rel="noopener" class="hidden md:inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="${t.platform.name}">
                  <img src="${t.platform.iconPrimary}" onerror="this.onerror=null;this.src='${t.platform.iconFallback}'" alt="${t.platform.name}" class="w-3.5 h-3.5 rounded-sm" referrerpolicy="no-referrer"/>
                </a>`:''}

              ${t.address?`<button class="copy relative shrink-0 hidden sm:inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200 dark:hover:bg-gray-700" data-copy="${t.address}" aria-label="Copiar CA">
                <svg viewBox="0 0 24 24" class="w-3.5 h-3.5" fill="currentColor" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                <span class="tooltip absolute top-7 right-0 bg-black text-white text-[10px] px-2 py-0.5 rounded opacity-0 pointer-events-none transition-opacity">Copiado</span>
              </button>`:''}
            </div>
          </td>

          <td class="w-28 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">
            ${t.priceUsd!=null?fmtUsdSmart(t.priceUsd):'â€”'}
          </td>

          <td class="w-16 sm:w-20 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap ${chgClass}">
            ${chg!=null?fmtNum(chg,2)+'%':'â€”'}
            <div class="mt-1 h-1.5 rounded-full overflow-hidden bg-gray-300/40 dark:bg-gray-700/50">
              <div class="${chg>=0?'bg-green-500':'bg-red-500'} h-1.5" style="width:${clampAbs(chg,15)/15*100}%"></div>
            </div>
          </td>

          <td class="w-24 sm:w-28 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">
            ${t.volume24!=null?fmtUsdCompact(t.volume24):'â€”'}
          </td>

          <td class="w-24 sm:w-28 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">
            ${t.liq!=null?fmtUsdCompact(t.liq):'â€”'}
          </td>

          <td class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">
            ${t.buys24!=null&&t.sells24!=null ? `${fmtNum(t.buys24,0)}Â·${fmtNum(t.sells24,0)}` : 'â€”'}
          </td>

          <td class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">
            ${(t.volume24!=null && (cap)) ? fmtNum((t.volume24/cap)*100,1)+'%' : 'â€”'}
          </td>

          <td class="w-24 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">
            <span class="md:hidden">${cap!=null?fmtUsdCompact(cap):'â€”'}</span>
            <span class="hidden md:inline">${cap!=null?fmtUsd(cap):'â€”'} <span class="ml-1 text-[10px] px-1 py-0.5 rounded bg-gray-100 dark:bg-gray-700 border dark:border-gray-600">${badge}</span></span>
          </td>`;
        tbody.appendChild(tr);

        const det=document.createElement('tr');
        det.className='details hidden bg-white/70 dark:bg-gray-800/70';
        det.innerHTML=`
          <td colspan="9" class="px-4 py-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 text-xs text-gray-700 dark:text-gray-300">
              <div class="md:col-span-4 flex items-center gap-2 text-sm">
                ${t.imageUrl?`<img src="${t.imageUrl}" class="w-5 h-5 rounded-full" alt="">`:''}
                <span class="font-semibold">${t.name||'â€”'}</span>
                <span class="text-xs text-gray-500 dark:text-gray-400 uppercase">${t.symbol}</span>
                <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-200 dark:bg-gray-700">${t.chainId}</span>
              </div>

              <div class="md:col-span-4 flex flex-wrap items-center gap-2">
                <span class="font-medium">CA:</span>
                <code class="font-mono text-xs sm:text-[13px] break-all md:whitespace-nowrap select-all">${t.address||'â€”'}</code>
                <button class="copy relative inline-flex items-center gap-1 border rounded px-2 py-0.5 ml-1 dark:border-gray-600" data-copy="${t.address||''}">
                  Copiar
                  <span class="tooltip absolute top-7 right-0 bg-black text-white text-[10px] px-2 py-0.5 rounded opacity-0 pointer-events-none transition-opacity">Copiado</span>
                </button>
              </div>

              <div><span class="font-medium">Liquidez:</span> ${t.liq!=null?fmtUsd(t.liq):'â€”'}</div>
              <div><span class="font-medium">Vol 24h:</span> ${t.volume24!=null?fmtUsd(t.volume24):'â€”'}</div>
              <div><span class="font-medium">Buy/Sell 24h:</span> ${t.buys24!=null&&t.sells24!=null?`${fmtNum(t.buys24,0)}Â·${fmtNum(t.sells24,0)}`:'â€”'}</div>
              <div><span class="font-medium">Market Cap:</span> ${(t.mc??t.fdv)!=null?fmtUsd(t.mc??t.fdv):'â€”'} (${t.mc!=null?'MC':(t.fdv!=null?'FDV':'â€”')})</div>
              ${t.fdv!=null?`<div><span class="font-medium">FDV:</span> ${fmtUsd(t.fdv)}</div>`:''}

              <div class="flex gap-2 flex-wrap md:col-span-4">
                ${t.url?`<a href="${t.url}" target="_blank" rel="noopener" class="border rounded px-3 py-1 dark:border-gray-600 inline-flex items-center gap-2"><img src="${ICONS.dex}" class="w-4 h-4 rounded-sm" alt=""> <span>Dexscreener</span></a>`:''}
                ${t.xUrl?`<a href="${t.xUrl}" target="_blank" rel="noopener" class="border rounded px-3 py-1 dark:border-gray-600 inline-flex items-center gap-2"><img src="${ICONS.x}" class="w-4 h-4 rounded-sm" alt=""> <span>X/Twitter</span></a>`:''}
                ${t.igUrl?`<a href="${t.igUrl}" target="_blank" rel="noopener" class="border rounded px-3 py-1 dark:border-gray-600 inline-flex items-center gap-2"><img src="${ICONS.ig}" class="w-4 h-4 rounded-sm" alt=""> <span>Instagram</span></a>`:''}
                ${t.ttUrl?`<a href="${t.ttUrl}" target="_blank" rel="noopener" class="border rounded px-3 py-1 dark:border-gray-600 inline-flex items-center gap-2"><img src="${ICONS.tt}" class="w-4 h-4 rounded-sm" alt=""> <span>TikTok</span></a>`:''}
                ${t.platform?`<a href="${t.platform.url}" target="_blank" rel="noopener" class="border rounded px-3 py-1 dark:border-gray-600 inline-flex items-center gap-2"><img src="${t.platform.iconPrimary}" onerror="this.onerror=null;this.src='${t.platform.iconFallback}'" class="w-4 h-4 rounded-sm" referrerpolicy="no-referrer" alt=""><span>${t.platform.name}</span></a>`:''}
              </div>
            </div>
          </td>`;
        tbody.appendChild(det);
      });
    }

    async function refresh(){
      try{
        statusEl.textContent='Cargandoâ€¦';
        const list=await loadTokenList();
        if(!list.length){ tbody.innerHTML=''; statusEl.textContent='Agrega tokens a tokens.json'; return; }
        const [pairs, socials] = await Promise.all([fetchAll(list), loadSocials()]);
        render(pairs, socials);
        updateTotalMc(pairs);
        updateTotalVol(pairs);
        updateFearIndex(pairs);
        statusEl.textContent=`Actualizado: ${new Date().toLocaleTimeString()} Â· Auto 60s`;
      }catch(err){
        console.error(err);
        statusEl.textContent='Error al actualizar.';
      }
    }

    const TOKENS_FALLBACK=[
      {"chain":"solana","address":"BS7HxRitaY5ipGfbek1nmatWLbaS9yoWRSEQzCb3pump"},
      {"chain":"solana","address":"DsMWZg6mkheTV2XTkbUtWcsXaajTzEkk1TC7o6Fmpump"},
      {"chain":"solana","address":"9Uxjbn2TyfEmjaYs1qXiLt3FbE3VDa5UMkvQGZwQpump"},
      {"chain":"solana","address":"9RLoB3YZwk9sK78ZhmiSAj8CtPhssuJR1pVR326Vpump"}
    ];

    document.getElementById('refreshBtn')?.addEventListener('click',refresh);
    refresh(); setInterval(refresh,60000);

    // ---------- NFTs ----------
    const nftTbody=document.getElementById('nftTbody');
    const nftStatus=document.getElementById('nftStatus');
    const nftRefreshBtn=document.getElementById('nftRefreshBtn');
    const NFT_REFRESH_MS=5*60*1000; let nftTimer=null;

    const ME_PROXY='https://latamcap-me.cryptonotaz.workers.dev';
    const XINFO_PROXY='https://latamcap-me.cryptonotaz.workers.dev/x';

    const NFTS_FALLBACK=[{chain:'solana',source:'magiceden',slug:'v1ps',name:'V1PS',image:'./v1ps-logo.png'}];

    function slugFromUrl(url){ if(!url) return null; const m=url.match(/\/marketplace\/([^\/?#]+)/i); return m?m[1]:null; }

    async function loadNftList(){
      try{
        const r=await fetch('./nfts.json?ts='+Date.now(),{cache:'no-store'});
        if(!r.ok) throw new Error('nfts.json ('+r.status+')');
        const raw=await r.json();
        if(!Array.isArray(raw)) throw new Error('nfts.json debe ser un array');
        return raw.map(it=>({...it,slug:it.slug||slugFromUrl(it.url)||'',supply:toNum(it.supply),floorSOL:toNum(it.floorSOL),listed:toNum(it.listed),vol24hSOL:toNum(it.vol24hSOL)})).filter(it=>it.slug);
      }catch(e){ console.warn('nfts.json no disponible/ invÃ¡lido, usando fallback',e); return NFTS_FALLBACK; }
    }

    async function fetchSolPrice(){
      try{const r=await fetch('https://price.jup.ag/v6/price?ids=SOL'); const j=await r.json(); const p=j?.data?.SOL?.price; if(typeof p==='number') return p;}catch{}
      try{const r=await fetch('https://price.jup.ag/v4/price?ids=SOL'); const j=await r.json(); const p=j?.data?.SOL?.price; if(typeof p==='number') return p;}catch{}
      try{const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd'); const j=await r.json(); const p=j?.solana?.usd; if(typeof p==='number') return p;}catch{}
      return null;
    }

    async function fetchFromProxy(slugs){
      const url=`${ME_PROXY}?slugs=${encodeURIComponent(slugs.join(','))}`;
      const r=await fetch(url,{headers:{'accept':'application/json'}});
      if(!r.ok) throw new Error('Proxy ME error '+r.status);
      return await r.json();
    }

    async function fetchNftsAll(cfgList){
      const slugs=cfgList.map(it=>it.slug).filter(Boolean);
      let proxy={}; if(ME_PROXY&&slugs.length){ try{ proxy=await fetchFromProxy(slugs); }catch(e){ console.warn(e); } }
      const rows=cfgList.map(cfg=>{
        const d=proxy[cfg.slug]||{};
        const floorSOL=(cfg.floorSOL!=null?cfg.floorSOL: (typeof d.floorLamports==='number'? d.floorLamports/1e9 : null));
        const listed=(cfg.listed!=null?cfg.listed:toNum(d.listed));
        const vol24hSOL=(cfg.vol24hSOL!=null?cfg.vol24hSOL:(typeof d.vol24hLamports==='number'? d.vol24hLamports/1e9 : null));
        const supProxy=toNum(d.supply ?? d.totalSupply ?? d.items ?? d.itemsAvailable ?? d.size ?? d.maxSupply);
        const supply=(cfg.supply!=null?cfg.supply:supProxy);
        return {slug:cfg.slug,name:cfg.name||d.name||cfg.slug,image:cfg.image||d.image||'',floorSOL,listed,vol24hSOL,supply,links:cfg.links||d.links||{me:`https://magiceden.io/marketplace/${cfg.slug}`}};
      });
      const anyHasFloor=rows.some(r=>typeof r.floorSOL==='number');
      const solUsd=anyHasFloor?await fetchSolPrice():null;
      return rows.map(x=>{
        const mcSOL=(typeof x.floorSOL==='number'&&typeof x.supply==='number')?x.floorSOL*x.supply:null;
        const mcUSD=(solUsd&&typeof mcSOL==='number')?mcSOL*solUsd:null;
        return {...x,floorUSD:(solUsd&&typeof x.floorSOL==='number')?x.floorSOL*solUsd:null,mcFloorSOL:mcSOL,mcFloorUSD:mcUSD};
      });
    }

    function renderNfts(rows){
      const nftTbody=document.getElementById('nftTbody');
      nftTbody.innerHTML='';
      rows.forEach((c,i)=>{
        const tr=document.createElement('tr');
        tr.className='group cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/40 leading-tight';
        tr.innerHTML=`
          <td class="w-6 px-2 py-2 sm:px-4 sm:py-3 text-gray-500 dark:text-gray-400">${i+1}</td>
          <td class="px-2 py-2 sm:px-4 sm:py-3">
            <div class="flex items-center gap-2 min-w-0">
              ${c.image?`<img src="${c.image}" class="w-5 h-5 rounded" alt="">`:''}
              <span class="font-semibold truncate">${c.name}</span>
            </div>
          </td>
          <td class="w-24 sm:w-28 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">${fmtSol(c.floorSOL)} ${c.floorUSD?`<span class='text-gray-500 dark:text-gray-400'>(${fmtUsd(c.floorUSD)})</span>`:''}</td>
          <td class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">${fmtSolCompact(c.vol24hSOL)}</td>
          <td class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">${c.supply!=null?fmtNum(c.supply,0):'â€”'}</td>
          <td class="w-24 sm:w-36 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">
            ${c.mcFloorUSD!=null?fmtUsdCompact(c.mcFloorUSD):(c.mcFloorSOL!=null?`â—Ž${fmtNum(c.mcFloorSOL,2)}`:'â€”')}
          </td>`;
        nftTbody.appendChild(tr);

        const det=document.createElement('tr');
        det.className='details hidden bg-white/70 dark:bg-gray-800/70';
        det.innerHTML=`
          <td colspan="6" class="px-4 py-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 text-xs text-gray-700 dark:text-gray-300">
              <div class="md:col-span-4 flex items-center gap-2 text-sm">
                ${c.image?`<img src="${c.image}" class="w-6 h-6 rounded" alt="">`:''}
                <span class="font-semibold">${c.name}</span>
                <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-200 dark:bg-gray-700">solana</span>
              </div>
              <div><span class="font-medium">Floor:</span> ${c.floorUSD?fmtUsd(c.floorUSD)+' Â· ':''}${fmtSol(c.floorSOL)}</div>
              <div><span class="font-medium">Listados:</span> ${c.listed??'â€”'}</div>
              <div><span class="font-medium">Vol 24h:</span> ${c.vol24hSOL==null?'â€”':`â—Ž${c.vol24hSOL.toFixed(2)}`}</div>
              ${c.supply!=null?`<div><span class="font-medium">Supply:</span> ${fmtNum(c.supply,0)}</div>`:''}
              <div class="flex gap-2">
                <a href="${c.links.me}" target="_blank" rel="noopener" class="border rounded px-3 py-1 dark:border-gray-600">Magic Eden</a>
                ${c.links.x?`<a href="${c.links.x}" target="_blank" rel="noopener" class="border rounded px-3 py-1 dark:border-gray-600">X/Twitter</a>`:''}
                ${c.links.web?`<a href="${c.links.web}" target="_blank" rel="noopener" class="border rounded px-3 py-1 dark:border-gray-600">Web</a>`:''}
                ${c.links.discord?`<a href="${c.links.discord}" target="_blank" rel="noopener" class="border rounded px-3 py-1 dark:border-gray-600">Discord</a>`:''}
              </div>
            </div>
          </td>`;
        nftTbody.appendChild(det);

        tr.addEventListener('click',(e)=>{ if(e.target.closest('a,button')) return; det.classList.toggle('hidden'); });
      });
    }

    async function nftRefresh(){
      try{
        nftStatus.textContent='Cargandoâ€¦';
        const list=await loadNftList();
        if(!list.length){ nftTbody.innerHTML=''; nftStatus.textContent='Agrega colecciones a nfts.json'; return; }
        const rowsRaw=await fetchNftsAll(list);
        const rows=[...rowsRaw].sort((a,b)=>(b.mcFloorUSD??0)-(a.mcFloorUSD??0)||(b.floorUSD??0)-(a.floorUSD??0)||(b.floorSOL??0)-(a.floorSOL??0));
        renderNfts(rows);
        nftStatus.textContent=`Actualizado: ${new Date().toLocaleTimeString()} Â· Auto 5m`;
      }catch(err){ console.error(err); nftStatus.textContent='Error al actualizar NFTs.'; }
    }

    // ---------- creadores ----------
    const creTbody=document.getElementById('creTbody');
    const creStatus=document.getElementById('creStatus');
    const creRefreshBtn=document.getElementById('creRefreshBtn');
    const CREATORS_REFRESH_MS=60*60*1000; let creTimer=null;

    const sumFollowers=(f={})=>['x','github','telegram','youtube','tiktok','instagram'].map(k=>Number(f[k]||0)).reduce((a,b)=>a+b,0);

    function handleFromXUrl(url){ if(!url) return null; const m=String(url).match(/(?:x\.com|twitter\.com)\/([^\/?#]+)/i); return m?m[1].replace(/^@/,''):null; }

    async function fetchXInfo(handles){
      const list=[...new Set(handles)].filter(Boolean);
      if(!list.length) return {};
      const url=`${XINFO_PROXY}?handles=${encodeURIComponent(list.join(','))}`;
      const r=await fetch(url,{headers:{'accept':'application/json'}});
      if(!r.ok) throw new Error('X proxy error '+r.status);
      return await r.json();
    }

    async function fetchCreatorsAll(list){
      const handles=list.map(c=>handleFromXUrl(c.x)).filter(Boolean);
      let info={}; try{ info=await fetchXInfo(handles); }catch(e){ console.warn(e); }
      return list.map(c=>{
        const h=handleFromXUrl(c.x); const key=h?h.toLowerCase():null; const xi=key?info[key]:null;
        return { name:c.name||xi?.name||h||'â€”', x:c.x||(h?`https://x.com/${h}`:null), avatar:c.avatar||xi?.avatar||null, roles:c.roles||[],
                 followers:{x:toNum(xi?.followers)??toNum(c.followers?.x)??0}, bio:c.bio||'', github:c.github||null, telegram:c.telegram||null,
                 youtube:c.youtube||null, tiktok:c.tiktok||null, instagram:c.instagram||null };
      });
    }

    async function loadCreators(){
      try{ const r=await fetch('./creators.json?ts='+Date.now(),{cache:'no-store'}); if(!r.ok) throw new Error('No creators.json'); const arr=await r.json(); return Array.isArray(arr)?arr:[]; }
      catch(e){ console.warn('Sin creators.json',e); return []; }
    }

    function renderCreators(rows){
      creTbody.innerHTML='';
      rows.forEach((c,i)=>{
        const total=sumFollowers(c.followers);
        const tr=document.createElement('tr');
        tr.className='group cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/40 leading-tight';
        tr.innerHTML=`
          <td class="w-6 px-2 py-2 sm:px-4 sm:py-3 text-gray-500 dark:text-gray-400">${i+1}</td>
          <td class="px-2 py-2 sm:px-4 sm:py-3">
            <div class="flex items-center gap-2 min-w-0">
              ${c.avatar?`<img src="${c.avatar}" class="w-6 h-6 rounded-full" alt="">`:''}
              <span class="font-semibold truncate">${c.name}</span>
              ${c.x?`<a class="inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200 dark:hover:bg-gray-700" target="_blank" rel="noopener" href="${c.x}" title="Perfil en X">
                <img src="https://abs.twimg.com/favicons/twitter.2.ico" class="w-3.5 h-3.5 rounded-sm" alt="X">
              </a>`:''}
            </div>
          </td>
          <td class="w-20 sm:w-24 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">${fmtNum(total||c.followers?.x||0,0)}</td>
          <td class="w-24 sm:w-28 px-2 py-2 sm:px-4 sm:py-3 text-right whitespace-nowrap">${(c.roles||[]).join(', ')||'â€”'}</td>`;
        creTbody.appendChild(tr);

        const det=document.createElement('tr');
        det.className='details hidden bg-white/70 dark:bg-gray-800/70';
        det.innerHTML=`
          <td colspan="4" class="px-4 py-3">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs text-gray-700 dark:text-gray-300">
              <div class="md:col-span-3">${c.bio?c.bio:''}</div>
              <div><span class="font-medium">Seguidores totales:</span> ${fmtNum(total||c.followers?.x||0,0)}</div>
              <div><span class="font-medium">Roles:</span> ${(c.roles||[]).join(', ')||'â€”'}</div>
              <div class="flex gap-2 flex-wrap">
                ${c.x?`<a class="border rounded px-3 py-1 dark:border-gray-600" target="_blank" rel="noopener" href="${c.x}">X/Twitter</a>`:''}
                ${c.github?`<a class="border rounded px-3 py-1 dark:border-gray-600" target="_blank" rel="noopener" href="${c.github}">GitHub</a>`:''}
                ${c.telegram?`<a class="border rounded px-3 py-1 dark:border-gray-600" target="_blank" rel="noopener" href="${c.telegram}">Telegram</a>`:''}
                ${c.youtube?`<a class="border rounded px-3 py-1 dark:border-gray-600" target="_blank" rel="noopener" href="${c.youtube}">YouTube</a>`:''}
                ${c.tiktok?`<a class="border rounded px-3 py-1 dark:border-gray-600" target="_blank" rel="noopener" href="${c.tiktok}">TikTok</a>`:''}
                ${c.instagram?`<a class="border rounded px-3 py-1 dark:border-gray-600" target="_blank" rel="noopener" href="${c.instagram}">Instagram</a>`:''}
              </div>
            </div>
          </td>`;
        creTbody.appendChild(det);

        tr.addEventListener('click',(e)=>{ if(e.target.closest('a')) return; det.classList.toggle('hidden'); });
      });
    }

    async function creRefresh(){
      try{
        creStatus.textContent='Cargandoâ€¦';
        const base=await loadCreators();
        if(!base.length){ creTbody.innerHTML=''; creStatus.textContent='Agrega perfiles a creators.json'; return; }
        const rowsRaw=await fetchCreatorsAll(base);
        const rows=[...rowsRaw].sort((a,b)=>(b.followers?.x||0)-(a.followers?.x||0));
        renderCreators(rows);
        creStatus.textContent=`Actualizado: ${new Date().toLocaleTimeString()} Â· Auto 1h`;
      }catch(err){ console.error(err); creStatus.textContent='Error al actualizar creadores.'; }
    }

    // ---------- tools ----------
    const toolsListEl=document.getElementById('toolsList');
    const toolsStatus=document.getElementById('toolsStatus');
    const toolsRefreshBtn=document.getElementById('toolsRefreshBtn');
    const TOOLS_REFRESH_MS=60*60*1000; let toolsTimer=null;

    const TOOLS_FALLBACK=[
      { name:'Bot de Trading Ejemplo', url:'https://t.me/exampleBot', desc:'Automatiza compras y ventas en Solana.', icon:'https://unavatar.io/telegram' },
      { name:'LatamCap Tools', url:'https://latamcap.id', desc:'Analiza tokens, NFTs y mÃ©tricas regionales.', icon:'./v1ps-logo.png' }
    ];

    async function loadTools(){
      try{
        const r=await fetch('./tools.json?ts='+Date.now(),{cache:'no-store'});
        if(!r.ok) throw new Error('No tools.json');
        const arr=await r.json();
        if(!Array.isArray(arr)) throw new Error('tools.json debe ser un array');
        return arr.map(t=>({
          name: t.name || 'Herramienta',
          url: t.url || '#',
          desc: t.desc || t.description || '',
          icon: t.icon || ''
        }));
      }catch(e){
        console.warn('tools.json no disponible, usando fallback', e);
        return TOOLS_FALLBACK;
      }
    }

    function renderTools(items){
      toolsListEl.innerHTML='';

      // --- Card del COMPARADOR como herramienta ---
      const cmp=document.createElement('button');
      cmp.type='button';
      cmp.id='openMcTool';
      cmp.className='text-left p-4 bg-white dark:bg-gray-800 rounded-xl shadow hover:opacity-90 transition flex gap-3 items-start w-full';
      cmp.innerHTML=`
        <div class="w-8 h-8 rounded-md grid place-items-center bg-gray-100 dark:bg-gray-700">
          <svg viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor" aria-hidden="true">
            <path d="M3 5h18v2H3V5zm3 6h12v2H6v-2zm-3 6h18v2H3v-2z"/>
          </svg>
        </div>
        <div class="min-w-0">
          <div class="font-semibold truncate">Comparador de Market Cap</div>
          <p class="text-sm text-gray-500 dark:text-gray-400">Calcula precio de A con el MC de B (usa MC/FDV).</p>
        </div>`;
      toolsListEl.appendChild(cmp);

      // Resto de herramientas
      items.forEach(it=>{
        const a=document.createElement('a');
        a.href=it.url; a.target='_blank'; a.rel='noopener';
        a.className='p-4 bg-white dark:bg-gray-800 rounded-xl shadow hover:opacity-90 transition flex gap-3 items-start';
        a.innerHTML=`
          ${it.icon?`<img src="${it.icon}" class="w-8 h-8 rounded-md" alt="">`:''}
          <div class="min-w-0">
            <div class="font-semibold truncate">${it.name}</div>
            ${it.desc?`<p class="text-sm text-gray-500 dark:text-gray-400 line-clamp-2">${it.desc}</p>`:''}
          </div>`;
        toolsListEl.appendChild(a);
      });
    }

    async function toolsRefresh(){
      try{
        toolsStatus.textContent='Cargandoâ€¦';
        const items=await loadTools();
        renderTools(items);
        toolsStatus.textContent=`Actualizado: ${new Date().toLocaleTimeString()} Â· Auto 1h`;
      }catch(err){
        console.error(err);
        toolsStatus.textContent='Error al cargar herramientas.';
      }
    }
    toolsRefreshBtn?.addEventListener('click', toolsRefresh);

    // ---------- tabs ----------
    const tabCoins=document.getElementById('tabCoins');
    const tabNfts=document.getElementById('tabNfts');
    const tabCreators=document.getElementById('tabCreators');
    const tabTools=document.getElementById('tabTools');
    const coinsSection=document.getElementById('coins-section');
    const nftsSection=document.getElementById('nfts-section');
    const creatorsSection=document.getElementById('creators-section');
    const toolsSection=document.getElementById('tools-section');

    function setActiveTab(tab){
      coinsSection.classList.toggle('hidden',tab!=='coins');
      nftsSection.classList.toggle('hidden',tab!=='nfts');
      creatorsSection.classList.toggle('hidden',tab!=='creators');
      toolsSection.classList.toggle('hidden',tab!=='tools');

      const on=['bg-black','text-white']; const off=['bg-gray-200','dark:bg-gray-700','dark:text-gray-100'];
      [tabCoins,tabNfts,tabCreators,tabTools].forEach(b=>b?.classList.remove(...on,...off));
      if(tab==='coins'){ tabCoins?.classList.add(...on); [tabNfts,tabCreators,tabTools].forEach(b=>b?.classList.add(...off)); }
      if(tab==='nfts'){ tabNfts?.classList.add(...on); [tabCoins,tabCreators,tabTools].forEach(b=>b?.classList.add(...off)); }
      if(tab==='creators'){ tabCreators?.classList.add(...on); [tabCoins,tabNfts,tabTools].forEach(b=>b?.classList.add(...off)); }
      if(tab==='tools'){ tabTools?.classList.add(...on); [tabCoins,tabNfts,tabCreators].forEach(b=>b?.classList.add(...off)); }

      clearInterval(nftTimer); clearInterval(creTimer); clearInterval(toolsTimer);
      if(tab==='nfts'){ if(!window.__nftInit){ nftRefresh(); window.__nftInit=true; } nftTimer=setInterval(nftRefresh,NFT_REFRESH_MS); }
      if(tab==='creators'){ if(!window.__creInit){ creRefresh(); window.__creInit=true; } creTimer=setInterval(creRefresh,CREATORS_REFRESH_MS); }
      if(tab==='tools'){ if(!window.__toolsInit){ toolsRefresh(); window.__toolsInit=true; } toolsTimer=setInterval(toolsRefresh,TOOLS_REFRESH_MS); }
    }

    tabCoins?.addEventListener('click',()=>setActiveTab('coins'));
    tabNfts?.addEventListener('click',()=>setActiveTab('nfts'));
    tabCreators?.addEventListener('click',()=>setActiveTab('creators'));
    tabTools?.addEventListener('click',()=>setActiveTab('tools'));

    // ---------- Gestos & copiar (coins) ----------
    async function copyTextSafe(text){
      try{ await navigator.clipboard.writeText(text); return true; }
      catch(e){ try{ const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.focus(); ta.select(); const ok=document.execCommand('copy'); document.body.removeChild(ta); return ok; } catch { return false; } }
    }
    let lpTimer=null; let suppressClickUntil=0;
    function showToastNear(el,text){
      try{ const r=el.getBoundingClientRect(); const tip=document.createElement('div'); tip.textContent=text; tip.style.position='fixed'; tip.style.left=(r.left+window.scrollX)+'px'; tip.style.top=(r.bottom+window.scrollY+6)+'px'; tip.className='z-50 bg-black text-white text-[10px] px-2 py-0.5 rounded shadow'; document.body.appendChild(tip); setTimeout(()=>tip.remove(),900);}catch(_){}
    }
    function lpStart(e){
      const t=e.target.closest('.lp-copy'); if(!t) return;
      if(lpTimer) clearTimeout(lpTimer);
      lpTimer=setTimeout(async()=>{ lpTimer=null; const text=t.getAttribute('data-copy')||''; if(!text) return; const ok=await copyTextSafe(text); showToastNear(t,ok?'Copiado':'No permitido'); suppressClickUntil=Date.now()+400; },550);
    }
    function lpEnd(){ if(lpTimer){ clearTimeout(lpTimer); lpTimer=null; } }
    tbody.addEventListener('touchstart',lpStart,{passive:true});
    tbody.addEventListener('mousedown',lpStart);
    ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>tbody.addEventListener(ev,lpEnd));

    tbody.addEventListener('click',async(e)=>{
      const copyBtn=e.target.closest('.copy');
      if(copyBtn){
        const text=copyBtn.getAttribute('data-copy')||''; let ok=false;
        if(text) ok=await copyTextSafe(text);
        if(!ok&&window.top!==window.self&&text){ try{ window.prompt('Copiar CA (selecciona y copia):',text); ok=true; }catch{} }
        const tip=copyBtn.querySelector('.tooltip'); if(tip){ tip.textContent=ok?'Copiado':'No permitido'; tip.classList.remove('opacity-0'); tip.classList.add('opacity-100'); setTimeout(()=>{ tip.classList.add('opacity-0'); tip.classList.remove('opacity-100'); tip.textContent='Copiado'; },1200); }
        e.stopPropagation(); return;
      }
      if(e.target.closest('a')) return;
      if(Date.now()<suppressClickUntil) return;
      const row=e.target.closest('tr'); if(!row) return;
      const details=row.nextElementSibling; if(details&&details.classList.contains('details')) details.classList.toggle('hidden');
    });

    setActiveTab('coins');

    (function(){
      const btn=document.getElementById('themeToggle'); if(!btn) return;
      const setTheme=(theme)=>{ document.documentElement.classList.toggle('dark',theme==='dark'); localStorage.setItem('theme',theme); btn.textContent=(theme==='dark')?'â˜€ï¸':'ðŸŒ™'; };
      setTheme(document.documentElement.classList.contains('dark')?'dark':'light');
      btn.addEventListener('click',()=>{ const next=document.documentElement.classList.contains('dark')?'light':'dark'; setTheme(next); });
    })();

    // ======= LÃ³gica del Comparador MC =======
    const mcModal = document.getElementById('mcModal');
    const mcClose = document.getElementById('mcClose');
    const selA = document.getElementById('mcSelectA');
    const selB = document.getElementById('mcSelectB');
    const mcCalcBtn = document.getElementById('mcCalc');
    const mcSwapBtn = document.getElementById('mcSwap');
    const mcMsg = document.getElementById('mcMsg');
    const mcOut = document.getElementById('mcOut');

    const capOf = (t)=> (typeof t?.mc==='number' ? t.mc : (typeof t?.fdv==='number' ? t.fdv : null));

    function populateMcSelects(){
      const list=(window.__LATAM_TOKENS||[]).filter(t=>t && t.priceUsd!=null && capOf(t)!=null);
      const toOpt = (t,idx)=>`<option value="${idx}">${t.symbol || t.name} Â· ${fmtUsdSmart(t.priceUsd)} Â· ${fmtUsdCompact(capOf(t))}</option>`;
      selA.innerHTML = list.map(toOpt).join('');
      selB.innerHTML = list.map(toOpt).join('');
      selA.dataset.len = list.length;
      selB.dataset.len = list.length;
      selA.selectedIndex = 0;
      selB.selectedIndex = Math.min(1, list.length-1);
    }

    function getRankByCap(list, token){
      const arr = [...list].sort((a,b)=>(capOf(b)||0)-(capOf(a)||0));
      const idx = arr.findIndex(x=>x.address===token.address);
      return (idx>=0) ? (idx+1) : null;
    }

    function computeMc(){
      const list=(window.__LATAM_TOKENS||[]).filter(t=>t && t.priceUsd!=null && capOf(t)!=null);
      if(list.length<2){ mcMsg.textContent='Agrega mÃ¡s tokens a tokens.json para comparar.'; mcOut.innerHTML=''; return; }

      const A=list[selA.selectedIndex], B=list[selB.selectedIndex];
      if(!A||!B){ mcMsg.textContent='Selecciona ambos tokens.'; mcOut.innerHTML=''; return; }
      if(A.address===B.address){ mcMsg.textContent='Selecciona tokens distintos.'; mcOut.innerHTML=''; return; }

      const pA=A.priceUsd, pB=B.priceUsd;
      const mcA=capOf(A), mcB=capOf(B);

      const pAeq = pA * (mcB / mcA);
      const pBeq = pB * (mcA / mcB);
      const chgA = ((pAeq - pA)/pA) * 100;
      const chgB = ((pBeq - pB)/pB) * 100;

      const ratioA = pAeq / pA;
      const ratioClass = ratioA > 1 ? 'text-emerald-600' : (ratioA < 1 ? 'text-red-500' : 'text-yellow-500');

      const rA = getRankByCap(list,A);
      const rB = getRankByCap(list,B);

      mcMsg.textContent='';

      mcOut.innerHTML = `
        <div class="mx-auto max-w-2xl rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-5 shadow">
          <div class="flex items-center gap-2 text-sm mb-2">
            <div class="w-5 h-5 rounded-full overflow-hidden">${A.imageUrl?`<img src="${A.imageUrl}" class="w-5 h-5" alt="">`:''}</div>
            <span class="font-semibold">${A.symbol||A.name}</span>
            <span class="text-gray-500">precio con el market cap de</span>
            <div class="w-5 h-5 rounded-full overflow-hidden">${B.imageUrl?`<img src="${B.imageUrl}" class="w-5 h-5" alt="">`:''}</div>
            <span class="font-semibold">${B.symbol||B.name}</span>
          </div>

          <div class="text-center my-2">
            <div class="text-3xl sm:text-4xl font-extrabold tabular-nums">${fmtUsdSmart(pAeq)}</div>
            <div class="mt-1 ${ratioClass} font-semibold">(${ratioA.toFixed(2)}x)</div>
          </div>

          <div class="grid sm:grid-cols-2 gap-3 mt-4 text-sm">
            <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-800/60 border border-gray-200 dark:border-gray-700">
              <div class="flex items-center justify-between">
                <span class="text-gray-600 dark:text-gray-400">${A.symbol||A.name} mcap ${rA?`<span class='ml-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-200 dark:bg-gray-700'>#${rA}</span>`:''}</span>
                <span class="font-semibold tabular-nums">${fmtUsd(mcA)}</span>
              </div>
            </div>
            <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-800/60 border border-gray-200 dark:border-gray-700">
              <div class="flex items-center justify-between">
                <span class="text-gray-600 dark:text-gray-400">${B.symbol||B.name} mcap ${rB?`<span class='ml-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-200 dark:bg-gray-700'>#${rB}</span>`:''}</span>
                <span class="font-semibold tabular-nums">${fmtUsd(mcB)}</span>
              </div>
            </div>
          </div>

          <div class="mt-4 grid sm:grid-cols-2 gap-3 text-xs text-gray-600 dark:text-gray-400">
            <div>
              Precio actual de ${A.symbol||A.name}:
              <span class="font-medium text-gray-900 dark:text-gray-100">${fmtUsdSmart(pA)}</span>
              <span class="${chgA>=0?'text-emerald-600':'text-red-500'} font-medium ml-1">(${fmtNum(chgA,2)}%)</span>
            </div>
            <div>
              Precio actual de ${B.symbol||B.name}:
              <span class="font-medium text-gray-900 dark:text-gray-100">${fmtUsdSmart(pB)}</span>
            </div>
          </div>

          <div class="mt-4 p-3 rounded-xl border border-dashed border-gray-300 dark:border-gray-700 text-sm">
            Si <strong>${B.symbol||B.name}</strong> tuviera el MC de <strong>${A.symbol||A.name}</strong> â†’
            <span class="font-semibold tabular-nums">${fmtUsdSmart(pBeq)}</span>
            <span class="${chgB>=0?'text-emerald-600':'text-red-500'}">(${fmtNum(chgB,2)}%)</span>
          </div>

          <div class="mt-4 flex items-center gap-2 text-xs text-gray-500">
            <img src="https://dexscreener.com/favicon.png" class="w-4 h-4 rounded-sm" alt="">
            <span>Datos base: Dexscreener (MC/FDV del listado cargado)</span>
          </div>
        </div>
      `;
    }

    // abrir/cerrar + calcular + swap
    document.addEventListener('click',(e)=>{
      if(e.target.closest('#openMcTool')){
        populateMcSelects();
        mcOut.innerHTML='';
        mcMsg.textContent = (Number(selA.dataset.len||0) < 2) ? 'Consejo: agrega mÃ¡s tokens a tokens.json para comparar.' : '';
        mcModal.classList.remove('hidden');
      }
    });
    mcClose?.addEventListener('click', ()=> mcModal.classList.add('hidden'));
    mcModal?.addEventListener('click', (e)=>{ if(e.target===mcModal) mcModal.classList.add('hidden'); });

    mcCalcBtn?.addEventListener('click', computeMc);

    mcSwapBtn?.addEventListener('click', ()=>{
      const iA = selA.selectedIndex;
      selA.selectedIndex = selB.selectedIndex;
      selB.selectedIndex = iA;
      computeMc();
    });
    // ======= /Comparador MC =======
  </script>
  <!-- ðŸŒ Cloudflare Web Analytics -->
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token":"c7335ec6ec0c4d8ba06040d145c5166f"}'></script>
</body>
</html>












